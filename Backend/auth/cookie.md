# Cookie (Auth ê´€ì )

## Cookieë€?

> ë¸Œë¼ìš°ì €ì— ì €ì¥ë˜ëŠ” ì‘ì€ ë°ì´í„° ì¡°ê°. ì„œë²„-í´ë¼ì´ì–¸íŠ¸ ê°„ ìƒíƒœ ìœ ì§€ì— ì‚¬ìš©

**ì¸ì¦ì—ì„œì˜ ì—­í• **

- ì„¸ì…˜ ID ì €ì¥
- JWT (Refresh Token) ì €ì¥
- ì‚¬ìš©ì ì‹ë³„ ì •ë³´ ìœ ì§€

---

## Cookie ì£¼ìš” ì†ì„±

| ì†ì„±                  | ì„¤ëª…                    | ì¸ì¦ ì‹œ ê¶Œì¥ê°’      |
| --------------------- | ----------------------- | ------------------- |
| **HttpOnly**          | JSì—ì„œ ì ‘ê·¼ ì°¨ë‹¨        | âœ… `true`           |
| **Secure**            | HTTPSì—ì„œë§Œ ì „ì†¡        | âœ… `true`           |
| **SameSite**          | í¬ë¡œìŠ¤ ì‚¬ì´íŠ¸ ìš”ì²­ ì œì–´ | `Strict` ë˜ëŠ” `Lax` |
| **Domain**            | ì¿ í‚¤ ì „ì†¡ ë„ë©”ì¸        | ëª…ì‹œì  ì„¤ì •         |
| **Path**              | ì¿ í‚¤ ì „ì†¡ ê²½ë¡œ          | `/` ë˜ëŠ” íŠ¹ì • ê²½ë¡œ  |
| **Max-Age / Expires** | ë§Œë£Œ ì‹œê°„               | ìš©ë„ì— ë§ê²Œ         |

---

## Client Cookie vs Server Cookie

### Client Cookie (JS ì ‘ê·¼ ê°€ëŠ¥)

```javascript
// ì„¤ì •
document.cookie = "theme=dark; path=/; max-age=86400";

// ì½ê¸°
console.log(document.cookie); // "theme=dark; lang=ko"
```

**íŠ¹ì§•**

- JavaScriptë¡œ ì½ê¸°/ì“°ê¸° ê°€ëŠ¥
- `HttpOnly` ì†ì„± **ì—†ìŒ**
- UI ì„¤ì •, ë¹„ë¯¼ê° ë°ì´í„°ìš©

### Server Cookie (HttpOnly)

```typescript
// Express
res.cookie('refreshToken', token, {
  httpOnly: true,   // JS ì ‘ê·¼ ì°¨ë‹¨
  secure: true,     // HTTPS only
  sameSite: 'strict',
  maxAge: 7 * 24 * 60 * 60 * 1000, // 7ì¼
  path: '/api/auth', // ì¸ì¦ ê²½ë¡œë§Œ
});

// NestJS
@Res() response: Response
response.cookie('refreshToken', token, { httpOnly: true, ... });
```

**íŠ¹ì§•**

- JavaScriptë¡œ ì ‘ê·¼ **ë¶ˆê°€**
- XSS ê³µê²©ìœ¼ë¡œë¶€í„° ë³´í˜¸
- ì¸ì¦ í† í° ì €ì¥ì— í•„ìˆ˜

---

## SameSite ì†ì„± ìƒì„¸

| ê°’         | ë™ì‘                      | CSRF ë°©ì–´ | ì‚¬ìš© ì‚¬ë¡€             |
| ---------- | ------------------------- | --------- | --------------------- |
| **Strict** | ê°™ì€ ì‚¬ì´íŠ¸ë§Œ             | âœ… ì™„ë²½   | ë¯¼ê°í•œ ì¸ì¦           |
| **Lax**    | ê°™ì€ ì‚¬ì´íŠ¸ + ì•ˆì „í•œ íƒìƒ‰ | ğŸ”º ë¶€ë¶„   | ì¼ë°˜ì  (ê¸°ë³¸ê°’)       |
| **None**   | ëª¨ë“  ìš”ì²­ (Secure í•„ìˆ˜)   | âŒ        | í¬ë¡œìŠ¤ ë„ë©”ì¸ í•„ìš” ì‹œ |

```
Strict: ì™¸ë¶€ ë§í¬ë¡œ ì ‘ê·¼ ì‹œ ì¿ í‚¤ ë¯¸ì „ì†¡
Lax: GET ë§í¬/formì€ ì „ì†¡, POSTëŠ” ë¯¸ì „ì†¡
None: í•­ìƒ ì „ì†¡ (ë°˜ë“œì‹œ Secure=true)
```

---

## ì¸ì¦ ì¿ í‚¤ ì„¤ì • ì˜ˆì‹œ

### Refresh Token ì €ì¥ (ê¶Œì¥)

```typescript
// ì„œë²„ì—ì„œ ì„¤ì •
res.cookie("refreshToken", refreshToken, {
  httpOnly: true, // XSS ë°©ì–´
  secure: true, // HTTPS
  sameSite: "strict", // CSRF ë°©ì–´
  path: "/api/auth", // ì¸ì¦ APIë§Œ
  maxAge: 7 * 24 * 60 * 60 * 1000,
});
```

### ì¿ í‚¤ ì‚­ì œ (ë¡œê·¸ì•„ì›ƒ)

```typescript
res.clearCookie("refreshToken", {
  httpOnly: true,
  secure: true,
  sameSite: "strict",
  path: "/api/auth", // ì„¤ì • ì‹œì™€ ë™ì¼í•´ì•¼ í•¨!
});
```

---

## ğŸ¯ Cookie ì„¤ì • ì²´í¬ë¦¬ìŠ¤íŠ¸

### Server Cookie (ì¸ì¦ í† í°)

- [ ] `HttpOnly: true` - JS ì ‘ê·¼ ì°¨ë‹¨
- [ ] `Secure: true` - HTTPSì—ì„œë§Œ ì „ì†¡
- [ ] `SameSite: Strict` ë˜ëŠ” `Lax`
- [ ] `Path` ì œí•œ - í•„ìš”í•œ ê²½ë¡œë§Œ
- [ ] ì ì ˆí•œ ë§Œë£Œ ì‹œê°„ ì„¤ì •
- [ ] ì‚­ì œ ì‹œ ë™ì¼ ì˜µì…˜ ì‚¬ìš©

### Client Cookie (ë¹„ë¯¼ê° ë°ì´í„°)

- [ ] ë¯¼ê° ì •ë³´ ì €ì¥ ì•ˆí•¨
- [ ] í† í°, ì„¸ì…˜ ID ì €ì¥ ê¸ˆì§€
- [ ] í•„ìš” ì‹œ ë§Œë£Œ ì‹œê°„ ì„¤ì •

### í¬ë¡œìŠ¤ ë„ë©”ì¸ í™˜ê²½

- [ ] `SameSite: None` + `Secure: true`
- [ ] CORS `credentials: true` ì„¤ì •
- [ ] ì„œë²„ `Access-Control-Allow-Credentials: true`
- [ ] `Access-Control-Allow-Origin`ì— ì™€ì¼ë“œì¹´ë“œ(\*) ì‚¬ìš© ë¶ˆê°€

### ë³´ì•ˆ ì ê²€

- [ ] Access Tokenì€ ì¿ í‚¤ ëŒ€ì‹  ë©”ëª¨ë¦¬/í—¤ë” ì‚¬ìš© ê³ ë ¤
- [ ] Refresh Tokenì€ ë°˜ë“œì‹œ HttpOnly
- [ ] CSRF í† í° ë³‘í–‰ ì‚¬ìš© (SameSite ë¯¸ì§€ì› ë¸Œë¼ìš°ì € ëŒ€ë¹„)
- [ ] ë¡œê·¸ì•„ì›ƒ ì‹œ ì„œë²„ì—ì„œë„ í† í° ë¬´íš¨í™”

---

## ì¼ë°˜ì ì¸ êµ¬ì„±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Access Token                                        â”‚
â”‚ - ì €ì¥: ë©”ëª¨ë¦¬ (ë³€ìˆ˜) ë˜ëŠ” Authorization í—¤ë”       â”‚
â”‚ - ë§Œë£Œ: 15ë¶„~1ì‹œê°„                                  â”‚
â”‚ - XSS ë…¸ì¶œ ìœ„í—˜ ìˆì§€ë§Œ ë‹¨ê¸° ë§Œë£Œë¡œ ë³´ì™„             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Refresh Token                                       â”‚
â”‚ - ì €ì¥: HttpOnly Cookie                             â”‚
â”‚ - ë§Œë£Œ: 7~30ì¼                                      â”‚
â”‚ - JS ì ‘ê·¼ ë¶ˆê°€, ì„œë²„ì—ì„œë§Œ ì²˜ë¦¬                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ì£¼ì˜ì‚¬í•­

- âš ï¸ `Secure: true`ëŠ” localhostì—ì„œ ì•ˆ ë¨ â†’ ê°œë°œ ì‹œ ì¡°ê±´ë¶€ ì„¤ì •
- âš ï¸ ì¿ í‚¤ ì‚­ì œ ì‹œ `path`, `domain` ë™ì¼í•´ì•¼ í•¨
- âš ï¸ SafariëŠ” `SameSite` ì²˜ë¦¬ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ
- âš ï¸ ì¿ í‚¤ í¬ê¸° ì œí•œ: 4KB (í† í°ì´ í¬ë©´ ë¬¸ì œ)

```typescript
// ê°œë°œ/ìš´ì˜ í™˜ê²½ ë¶„ê¸°
const cookieOptions = {
  httpOnly: true,
  secure: process.env.NODE_ENV === "production",
  sameSite: process.env.NODE_ENV === "production" ? "strict" : "lax",
};
```

---

## ë¹ ë¥¸ ì„ íƒ ê°€ì´ë“œ

```
ì €ì¥í•  ë°ì´í„°?
â”œâ”€â”€ ì¸ì¦ í† í° (Refresh Token)
â”‚   â””â”€â”€ HttpOnly + Secure + SameSite:Strict
â”œâ”€â”€ ì„¸ì…˜ ID
â”‚   â””â”€â”€ HttpOnly + Secure + SameSite:Strict
â”œâ”€â”€ UI ì„¤ì • (í…Œë§ˆ, ì–¸ì–´)
â”‚   â””â”€â”€ Client Cookie (HttpOnly ì—†ìŒ)
â””â”€â”€ í¬ë¡œìŠ¤ ë„ë©”ì¸ ì¸ì¦
    â””â”€â”€ HttpOnly + Secure + SameSite:None + CORS ì„¤ì •
```
